name: Daily Actions Smoke
# Validated YAML for scheduled + manual smoke PR flow.

on:
  schedule:
    # 08:00 KST = 23:00 UTC (previous day)
    - cron: "0 23 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  smoke:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml tqdm

      - name: Compile all Python files
        run: python -m compileall -q .

      - name: Write smoke result JSON
        run: |
          DATE_KST="$(TZ=Asia/Seoul date +%F)"
          OUT_DIR="results/daily/${DATE_KST}/actions_smoke"
          mkdir -p "${OUT_DIR}"
          python -c "import json,sys,platform,pathlib; p=pathlib.Path('${OUT_DIR}')/'results.json'; p.write_text(json.dumps({'python_version':sys.version,'python_executable':sys.executable,'platform':platform.platform(),'system':platform.system(),'machine':platform.machine()}, ensure_ascii=False, indent=2), encoding='utf-8')"

      - name: Ensure RESULTS.md header and append artifact line
        run: |
          DATE_KST="$(TZ=Asia/Seoul date +%F)"
          ARTIFACT_PATH="results/daily/${DATE_KST}/actions_smoke/results.json"
          if [ ! -f RESULTS.md ] || [ ! -s RESULTS.md ]; then
            printf "# Daily Actions Smoke Results\n\n" > RESULTS.md
          fi
          printf -- "- %s: %s\n" "${DATE_KST}" "${ARTIFACT_PATH}" >> RESULTS.md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: bot/daily-actions-smoke
          title: "ci: daily actions smoke update"
          commit-message: "ci: add daily actions smoke result"
          body: |
            Automated daily Actions smoke run.
            - Compiled Python files
            - Wrote smoke metadata JSON
            - Updated RESULTS.md
          add-paths: |
            results/daily/**
            RESULTS.md
