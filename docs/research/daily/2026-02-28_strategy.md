# 2026-02-28 (Sat) — Matbench 전략 업데이트

## 1) 최근 1~3일 성능 추이 요약 (mp_e_form)

### 최신 결과 스냅샷 (results/daily)
- **2026-02-27**
  - `chgnet_pretrained_infer` (zero-shot pretrained) → **MAE=4.7541 eV/atom** (성공)
  - `chgnet_head_finetune_freeze` → **ERROR** (학습 진입 전 에러)
  - `chgnet_full_finetune` → **ERROR** (학습 진입 전 에러)
- **2026-02-26**
  - `chgnet_pretrained_infer` → **MAE=4.7541 eV/atom** (성공)
  - `chgnet_head_finetune_freeze` → **ERROR** (`KeyError: 'fold_0'` 형태의 fold 키 이슈)
  - `chgnet_full_finetune` → **ERROR** (`KeyError: 'fold_0'`)
- **2026-02-25**
  - 일부 `results.json`에 **git merge conflict 마커(<<<<<<<)** 가 남아 있어 JSON 파싱/집계가 불가 (CI 산출물 신뢰도 낮음)

### 장기 관측(RESULTS.md)
- 현재까지 **유의미하게 낮은 MAE가 기록된 것은 HGB baseline 0.49346** 1건.
  - `2026-02-20 | matbench_mp_e_form | structure_simple+HGB | MAE=0.49346`
- 반면 CHGNet zero-shot은 2/26~2/27 동안 **MAE≈4.754로 정체** (사실상 “작동 확인” 수준).

**요약 결론:** 지난 2~3일은 **성능 개선(Top-1 방향)** 이 아니라, **(a) CHGNet 파이프라인이 돌아는 감 + (b) finetune 파이프라인이 에러로 막힘** 상태.

근거 파일:
- `RESULTS.md`
- `results/daily/2026-02-26/daily10/chgnet_pretrained_infer/results.json`
- `results/daily/2026-02-27/daily10/chgnet_pretrained_infer/results.json`


## 2) 타깃: mp_e_form 기본 유지 + mp_gap 전환/병행 조건

### 기본 타깃 유지: **mp_e_form**
- 목표(Top-1)가 mp_e_form이면, 당연히 메인 리소스는 여기에 둬야 함.

### mp_gap 병행을 “제안”하는 조건 (권장)
- **학습/평가 파이프라인 디버깅용 보조 트랙**이 필요할 때.
  - 특히 현재 CHGNet finetune은 fold 처리/데이터 취급/디바이스 이슈 등으로 연속 실패.
  - mp_gap으로 “더 빨리/더 자주” 성공 로그를 쌓아, **훈련 루프/캐시/스플릿 로직 안정화**를 먼저 확인하는 용도.

(참고: Matbench 프로젝트/태스크 개요) https://matbench.materialsproject.org/


## 3) Top-1을 위한 ‘다음 24h’ 최선 전략 1개

### 선정 전략 (1개): **CHGNet finetune 파이프라인을 ‘완주 가능한 상태’로 만들고, 0.1 fraction → 1.0 full로 올리는 2-step**

**왜 이게 24h 최선인가**
- 현재 성능 병목은 “모델 선택” 이전에 **훈련이 끝까지 안 돌아가는 공학적 병목**임.
- Top-1은 결국 강한 GNN/사전학습/앙상블 쪽으로 가야 하는데, 그 전에
  1) 5-fold를 끝까지 돌리고
  2) 지표를 일관되게 로깅하고
  3) 재현 가능한 설정(시드/캐시/디바이스)을 확보
  가 선행돼야 함.
- CHGNet은 이미 코드/실험틀이 있으며, zero-shot이 성능이 나쁘더라도 **finetune으로 급격히 내려갈 여지**가 큼.

**핵심 리스크**
- (R1) fold 키 이슈: `task.folds`가 `fold_0` 같은 문자열을 반환할 때, `get_train_and_val_data()`가 int fold를 기대하면 연속 실패.
- (R2) 디바이스 mismatch: 일부 모듈/텐서가 CPU에 남아 `Expected all tensors to be on the same device`류 런타임 에러 가능.
- (R3) 데이터 fraction/캐시 코드에서 변수가 정의되지 않는 분기(`UnboundLocalError`)가 재발할 수 있음(과거 로그에 존재).

**실행 단계 (오늘 안에 끝내는 순서)**
1) **fold normalizer를 “항상” 적용**
   - `folds == "all"`일 때도 `fold_0` → `0`으로 변환하도록 수정.
2) **모델/배치/그래프 입력이 모두 동일 device로 이동하는지 점검**
   - `model.to(device)` 및 그래프/텐서 이동 함수가 빠진 경로가 없는지 확인.
3) **agile 설정(예: data_fraction=0.1)으로 5-fold 완주**
   - 목적: 성능이 아니라 “완주 + 결과 JSON이 clean하게 찍힘”
4) (완주 확인 후) **full 데이터(1.0)로 1회 완주**

CHGNet 참고: https://github.com/CederGroupHub/chgnet


## 4) 오늘 AM/PM 2-run 계획 (바꾸는 변수 1개 원칙)

### AM Run (디버그/완주 확인)
- 목표: **실패 원인 제거 + 5-fold 완주 성공**
- 고정: 모델=CHGNet finetune 파이프라인 (`chgnet_full_finetune` 권장)
- 변경 변수(1개): **data_fraction = 0.1 (또는 train_fraction/val_fraction 관련 파라미터 0.1)**
- 체크리스트:
  - 결과 파일이 JSON merge-conflict 없이 정상 저장되는지
  - fold가 `0..4`로 정상 순회되는지
  - GPU device mismatch 재발 없는지

### PM Run (성능 끌어올리기 1-step)
- 목표: **동일 설정에서 데이터만 full로 올려 “첫 정상 finetune MAE” 확보**
- 고정: AM과 동일한 나머지 설정(epochs/lr/freeze/seed/캐시)
- 변경 변수(1개): **data_fraction: 0.1 → 1.0**
- 산출물:
  - fold별 MAE + mean/std가 기록된 results.json
  - RESULTS.md에 1줄 추가(성공한 설정만)


---

## Appendix: 오늘 확인된 ‘즉시 고쳐야 하는 신뢰성 이슈’
- `results/daily/2026-02-25/.../results.json`에 merge conflict 마커가 포함됨 → **CI/실험 산출물 파이프라인 신뢰도 훼손**
  - 우선순위: (1) 해당 파일 생성 로직에서 git conflict가 끼지 않도록, (2) 결과물은 항상 깨끗한 JSON만 저장.
